{"version":3,"file":"predicate.test.js","sourceRoot":"","sources":["../../../../test/compile/selection/predicate.test.ts"],"names":[],"mappings":"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","sourcesContent":["/* tslint:disable quotemark */\n\nimport {assert} from 'chai';\nimport {nonPosition} from '../../../src/compile/mark/mixins';\nimport * as selection from '../../../src/compile/selection/selection';\nimport {expression} from '../../../src/predicate';\nimport {VgEncodeEntry} from '../../../src/vega.schema';\nimport {parseUnitModel} from '../../util';\n\nconst predicate = selection.selectionPredicate;\n\ndescribe('Selection Predicate', () => {\n  const model = parseUnitModel({\n    mark: 'circle',\n    encoding: {\n      x: {field: 'Horsepower', type: 'quantitative'},\n      y: {field: 'Miles_per_Gallon', type: 'quantitative'},\n      color: {\n        field: 'Cylinders',\n        type: 'ordinal',\n        condition: {\n          selection: 'one',\n          value: 'grey'\n        }\n      },\n      opacity: {\n        field: 'Origin',\n        type: 'nominal',\n        condition: {\n          selection: {or: ['one', {and: ['two', {not: 'thr-ee'}]}]},\n          value: 0.5\n        }\n      }\n    }\n  });\n\n  model.parseScale();\n\n  model.component.selection = selection.parseUnitSelection(model, {\n    one: {type: 'single'},\n    two: {type: 'multi', resolve: 'union'},\n    'thr-ee': {type: 'interval', resolve: 'intersect'},\n    four: {type: 'single', empty: 'none'}\n  });\n\n  it('generates the predicate expression', () => {\n    assert.equal(predicate(model, 'one'), '!(length(data(\"one_store\"))) || (vlSingle(\"one_store\", datum))');\n\n    assert.equal(predicate(model, 'four'), '(vlSingle(\"four_store\", datum))');\n\n    assert.equal(predicate(model, {not: 'one'}), '!(length(data(\"one_store\"))) || (!(vlSingle(\"one_store\", datum)))');\n\n    assert.equal(\n      predicate(model, {not: {and: ['one', 'two']}}),\n      '!(length(data(\"one_store\")) || length(data(\"two_store\"))) || ' +\n        '(!((vlSingle(\"one_store\", datum)) && ' +\n        '(vlMulti(\"two_store\", datum, \"union\"))))'\n    );\n\n    assert.equal(\n      predicate(model, {not: {and: ['one', 'four']}}),\n      '!(length(data(\"one_store\"))) || ' + '(!((vlSingle(\"one_store\", datum)) && ' + '(vlSingle(\"four_store\", datum))))'\n    );\n\n    assert.equal(\n      predicate(model, {and: ['one', 'two', {not: 'thr-ee'}]}),\n      '!(length(data(\"one_store\")) || length(data(\"two_store\")) || length(data(\"thr_ee_store\"))) || ' +\n        '((vlSingle(\"one_store\", datum)) && ' +\n        '(vlMulti(\"two_store\", datum, \"union\")) && ' +\n        '(!(vlInterval(\"thr_ee_store\", datum, \"intersect\"))))'\n    );\n\n    assert.equal(\n      predicate(model, {or: ['one', {and: ['two', {not: 'thr-ee'}]}]}),\n      '!(length(data(\"one_store\")) || length(data(\"two_store\")) || length(data(\"thr_ee_store\"))) || ' +\n        '((vlSingle(\"one_store\", datum)) || ' +\n        '((vlMulti(\"two_store\", datum, \"union\")) && ' +\n        '(!(vlInterval(\"thr_ee_store\", datum, \"intersect\")))))'\n    );\n  });\n\n  it('generates Vega production rules', () => {\n    assert.deepEqual<VgEncodeEntry>(nonPosition('color', model, {vgChannel: 'fill'}), {\n      fill: [\n        {test: '!(length(data(\"one_store\"))) || (vlSingle(\"one_store\", datum))', value: 'grey'},\n        {scale: 'color', field: 'Cylinders'}\n      ]\n    });\n\n    assert.deepEqual<VgEncodeEntry>(nonPosition('opacity', model), {\n      opacity: [\n        {\n          test:\n            '!(length(data(\"one_store\")) || length(data(\"two_store\")) || length(data(\"thr_ee_store\"))) || ' +\n            '((vlSingle(\"one_store\", datum)) || ' +\n            '((vlMulti(\"two_store\", datum, \"union\")) && ' +\n            '(!(vlInterval(\"thr_ee_store\", datum, \"intersect\")))))',\n          value: 0.5\n        },\n        {scale: 'opacity', field: 'Origin'}\n      ]\n    });\n  });\n\n  it('generates a selection filter', () => {\n    assert.equal(\n      expression(model, {selection: 'one'}),\n      '!(length(data(\"one_store\"))) || (vlSingle(\"one_store\", datum))'\n    );\n\n    assert.equal(\n      expression(model, {selection: {not: 'one'}}),\n      '!(length(data(\"one_store\"))) || (!(vlSingle(\"one_store\", datum)))'\n    );\n\n    assert.equal(\n      expression(model, {selection: {not: {and: ['one', 'two']}}}),\n      '!(length(data(\"one_store\")) || length(data(\"two_store\"))) || ' +\n        '(!((vlSingle(\"one_store\", datum)) && ' +\n        '(vlMulti(\"two_store\", datum, \"union\"))))'\n    );\n\n    assert.equal(\n      expression(model, {selection: {and: ['one', 'two', {not: 'thr-ee'}]}}),\n      '!(length(data(\"one_store\")) || length(data(\"two_store\")) || length(data(\"thr_ee_store\"))) || ' +\n        '((vlSingle(\"one_store\", datum)) && ' +\n        '(vlMulti(\"two_store\", datum, \"union\")) && ' +\n        '(!(vlInterval(\"thr_ee_store\", datum, \"intersect\"))))'\n    );\n\n    assert.equal(\n      expression(model, {selection: {or: ['one', {and: ['two', {not: 'thr-ee'}]}]}}),\n      '!(length(data(\"one_store\")) || length(data(\"two_store\")) || length(data(\"thr_ee_store\"))) || ' +\n        '((vlSingle(\"one_store\", datum)) || ' +\n        '((vlMulti(\"two_store\", datum, \"union\")) && ' +\n        '(!(vlInterval(\"thr_ee_store\", datum, \"intersect\")))))'\n    );\n  });\n\n  it('throws an error for unknown selections', () => {\n    assert.throws(() => predicate(model, 'helloworld'), 'Cannot find a selection named \"helloworld\"');\n  });\n});\n"]}